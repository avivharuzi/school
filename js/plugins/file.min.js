(function(e,t){e.formUtils.registerLoadedModule("file");var i="undefined"!=typeof t.FileReader,r=function(t){var i=e.split((t.valAttr("allowing")||"").toLowerCase());return e.inArray("jpg",i)>-1&&e.inArray("jpeg",i)===-1?i.push("jpeg"):e.inArray("jpeg",i)>-1&&e.inArray("jpg",i)===-1&&i.push("jpg"),i},n=function(e,t,i,r){var n=r[t]||"";e.errorMessageKey="",e.errorMessage=n.replace("%s",i)},a=function(i,r,n){var a=new FileReader,o=new Image;a.readAsDataURL(i),a.onload=function(i){o.onload=function(){e(t).trigger("imageValidation",[this]),r(this)},o.onerror=function(){n()},o.src=i.target.result}};e.formUtils.addValidator({name:"mime",validatorFunction:function(t,a,o,s){if(i){var l=!0,g=a.get(0).files||[],u="",d=r(a);return g.length&&(e.each(g,function(t,i){return l=!1,u=i.type||i.name.substring(i.name.lastIndexOf(".")+1),e.each(d,function(e,t){if(l=u.indexOf(t)>-1)return!1}),l}),l||(e.formUtils.warn("Trying to upload a file with mime type "+u+" which is not allowed"),n(this,"wrongFileType",d.join(", "),s))),l}return e.formUtils.warn("FileReader not supported by browser, will check file extension"),e.formUtils.validators.validate_extension.validatorFunction(t,a,o,s)},errorMessage:"",errorMessageKey:"wrongFileType"}),e.formUtils.addValidator({name:"extension",validatorFunction:function(t,i,a,o){var s=!0,l=this,g=r(i);return e.each(i.get(0).files||[t],function(t,i){var r="string"==typeof i?i:i.value||i.fileName||i.name,a=r.substr(r.lastIndexOf(".")+1);if(e.inArray(a.toLowerCase(),g)===-1)return s=!1,n(l,"wrongFileType",g.join(", "),o),!1}),s},errorMessage:"",errorMessageKey:"wrongFileType"}),e.formUtils.addValidator({name:"size",validatorFunction:function(t,r,a,o){var s=r.valAttr("max-size");if(!s)return e.formUtils.warn('Input "'+r.attr("name")+'" is missing data-validation-max-size attribute',!0),!0;if(!i)return!0;var l=e.formUtils.convertSizeNameToBytes(s),g=!0;return e.each(r.get(0).files||[],function(e,t){return g=t.size<=l}),g||n(this,"wrongFileSize",s,o),g},errorMessage:"",errorMessageKey:"wrongFileSize"}),e.formUtils.convertSizeNameToBytes=function(e){return e=e.toUpperCase(),"M"===e.substr(e.length-1,1)?1024*parseInt(e.substr(0,e.length-1),10)*1024:"MB"===e.substr(e.length-2,2)?1024*parseInt(e.substr(0,e.length-2),10)*1024:"KB"===e.substr(e.length-2,2)?1024*parseInt(e.substr(0,e.length-2),10):"B"===e.substr(e.length-1,1)?parseInt(e.substr(0,e.length-1),10):parseInt(e,10)},e.formUtils.checkImageDimension=function(e,t,i){var r=!1,n={width:0,height:0},a=function(e){e=e.replace("min","").replace("max","");var t=e.split("x");n.width=t[0],n.height=t[1]?t[1]:t[0]},o=!1,s=!1,l=t.split("-");return 1===l.length?0===l[0].indexOf("min")?o=l[0]:s=l[0]:(o=l[0],s=l[1]),o&&(a(o),(e.width<n.width||e.height<n.height)&&(r=i.imageTooSmall+" ("+i.min+" "+n.width+"x"+n.height+"px)")),!r&&s&&(a(s),(e.width>n.width||e.height>n.height)&&(r=e.width>n.width?i.imageTooWide+" "+n.width+"px":i.imageTooTall+" "+n.height+"px",r+=" ("+i.max+" "+n.width+"x"+n.height+"px)")),r},e.formUtils.checkImageRatio=function(e,t,i){var r=e.width/e.height,n=function(e){var t=e.replace("max","").replace("min","").split(":");return t[0]/t[1]},a=t.split("-"),o=function(e,t,i){return e>=t&&e<=i};if(1===a.length){if(r!==n(a[0]))return i.imageRatioNotAccepted}else if(2===a.length&&!o(r,n(a[0]),n(a[1])))return i.imageRatioNotAccepted;return!1},e.formUtils.addAsyncValidator({name:"dimension",validatorFunction:function(t,r,n,o,s){if(i){var l=n.get(0).files||[],g=this;n.attr("data-validation").indexOf("mime")===-1?(alert("You should validate file type being jpg, gif or png on input "+n[0].name),t(!1)):l.length>1?(alert("Validating image dimensions does not support inputs allowing multiple files"),t(!1)):0===l.length?t(!0):a(l[0],function(i){var r=!1;n.valAttr("dimension")&&(r=e.formUtils.checkImageDimension(i,n.valAttr("dimension"),s)),!r&&n.valAttr("ratio")&&(r=e.formUtils.checkImageRatio(i,n.valAttr("ratio"),s)),r?(g.errorMessage=s.wrongFileDim+" "+n.valAttr("has-not-valid-dim"),t(!1)):t(!0)},function(e){throw e})}else t(!0)},errorMessage:"",errorMessageKey:""}),e(t).one("validatorsLoaded formValidationSetup",function(t,i,r){var n;n=i?i.find('input[type="file"]'):e('input[type="file"]'),e.formUtils.dialogs.removeInputStylingAndMessage(n,r)})})(jQuery,window);